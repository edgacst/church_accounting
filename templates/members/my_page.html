{% extends 'base.html' %}
{% load humanize %}

{% block title %}ë§ˆì´ í˜ì´ì§€ - êµíšŒ ì¬ì • ê´€ë¦¬ ì‹œìŠ¤í…œ{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">
        <i class="bi bi-person-circle"></i> ë§ˆì´ í˜ì´ì§€
    </h2>

    <div class="row">
        <!-- ì‚¬ìš©ì ì •ë³´ -->
        <div class="col-md-4 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <i class="bi bi-person-vcard"></i> ë‚´ ì •ë³´
                </div>
                <div class="card-body">
                    <p><strong>ì‚¬ìš©ìëª…:</strong> {{ user.username }}</p>
                    <p><strong>ì´ë©”ì¼:</strong> {{ user.email|default:"ë¯¸ë“±ë¡" }}</p>
                    <p><strong>ê°€ì…ì¼:</strong> {{ user.date_joined|date:"Y-m-d" }}</p>
                    <p><strong>ê¶Œí•œ:</strong> {% if user.is_staff %}ê´€ë¦¬ì{% else %}ì¼ë°˜ ì‚¬ìš©ì{% endif %}</p>
                    
                    {% if member %}
                    <hr>
                    <h6 class="text-primary">êµì¸ ì •ë³´</h6>
                    <p><strong>ì´ë¦„:</strong> {{ member.korean_name }}</p>
                    <p><strong>ë¶€ì„œ:</strong> {{ member.department|default:"ë¯¸ì†Œì†" }}</p>
                    <p><strong>ì§ë¶„:</strong> {{ member.position|default:"-" }}</p>
                    <p><strong>í—Œê¸ˆë´‰íˆ¬:</strong> {{ member.offering_number|default:"-" }}</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- ì§€ì¶œ ì‹ ì²­ í†µê³„ -->
        <div class="col-md-8 mb-4">
            <div class="card mb-3">
                <div class="card-header bg-success text-white">
                    <i class="bi bi-bar-chart"></i> ì§€ì¶œ ì‹ ì²­ í†µê³„
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <h4 class="text-primary">{{ my_transactions.count }}</h4>
                            <small class="text-muted">ì´ ì‹ ì²­ ê±´ìˆ˜</small>
                        </div>
                        <div class="col-md-3">
                            <h4 class="text-success">{{ approved_count }}</h4>
                            <small class="text-muted">ìŠ¹ì¸</small>
                        </div>
                        <div class="col-md-3">
                            <h4 class="text-warning">{{ pending_count }}</h4>
                            <small class="text-muted">ëŒ€ê¸°</small>
                        </div>
                        <div class="col-md-3">
                            <h4 class="text-danger">{{ rejected_count }}</h4>
                            <small class="text-muted">ë°˜ë ¤</small>
                        </div>
                    </div>
                    <hr>
                    <div class="text-center">
                        <p class="mb-0">
                            <strong>ì´ ì‹ ì²­ ê¸ˆì•¡:</strong> 
                            <span class="text-primary fs-5">{{ total_requested|floatformat:0|default:"0" }}ì›</span>
                        </p>
                    </div>
                </div>
            </div>

            <!-- ìµœê·¼ ì§€ì¶œ ì‹ ì²­ ë‚´ì—­ -->
            <div class="card">
                <div class="card-header bg-info text-white">
                    <i class="bi bi-list-ul"></i> ìµœê·¼ ì§€ì¶œ ì‹ ì²­ ë‚´ì—­
                    <a href="{% url 'budget:expense_request_list' %}" class="btn btn-sm btn-light float-end">ì „ì²´ ë³´ê¸°</a>
                </div>
                <div class="card-body">
                    {% if my_transactions %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ì‹ ì²­ì¼</th>
                                    <th>ë‚´ìš©</th>
                                    <th>ê¸ˆì•¡</th>
                                    <th>ìƒíƒœ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for transaction in my_transactions %}
                                <tr>
                                    <td>{{ transaction.transaction_date|date:"Y-m-d" }}</td>
                                    <td>
                                        <a href="{% url 'budget:expense_request_detail' transaction.pk %}">
                                            {{ transaction.description|truncatewords:5 }}
                                        </a>
                                    </td>
                                    <td>{{ transaction.amount|floatformat:0 }}ì›</td>
                                    <td>
                                        {% if transaction.status == 'approved' %}
                                            <span class="badge bg-success">ìŠ¹ì¸ë¨</span>
                                        {% elif transaction.status == 'pending' %}
                                            <span class="badge bg-warning">ëŒ€ê¸°ì¤‘</span>
                                        {% else %}
                                            <span class="badge bg-danger">ë°˜ë ¤ë¨</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted text-center">ì§€ì¶œ ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- ë‚´ í—Œê¸ˆ ë‚´ì—­ (êµì¸ ì •ë³´ê°€ ìˆëŠ” ê²½ìš°) -->
    {% if member %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card" style="border-left: 5px solid #f39c12;">
                <div class="card-header" style="background: linear-gradient(135deg, #f39c12, #f1c40f); color: white;">
                    <i class="bi bi-cash-coin"></i> ğŸ“ ë‚´ í—Œê¸ˆ ë‚´ì—­
                    <span class="badge bg-light text-dark float-end" style="font-size: 1.1em;">ì´ {{ total_offering|intcomma }}ì›</span>
                </div>
                <div class="card-body">
                    {% if my_offerings %}
                    <div class="table-responsive">
                        <table class="table table-hover" style="margin-bottom: 0;">
                            <thead style="background: #f8f9fa;">
                                <tr>
                                    <th style="border-top: none;">í—Œê¸ˆì¼</th>
                                    <th style="border-top: none;">í—Œê¸ˆ ì¢…ë¥˜</th>
                                    <th style="border-top: none;">ê¸ˆì•¡</th>
                                    <th style="border-top: none;">ë©”ëª¨</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for offering in my_offerings %}
                                <tr>
                                    <td>{{ offering.offering_date|date:"Y-m-d" }}</td>
                                    <td><strong>{{ offering.offering_type.name }}</strong></td>
                                    <td><strong style="color: #e74c3c;">{{ offering.amount|intcomma }}ì›</strong></td>
                                    <td style="color: #7f8c8d;">{{ offering.notes|default:"-" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-3 text-end">
                        <a href="{% url 'offerings:tax_certificate_list' %}" style="color:#007bff; font-weight:bold; font-size:1.1em; text-decoration:underline;">
                            í—Œê¸ˆ ì¦ëª…ì„œ ë°œê¸‰
                        </a>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-inbox" style="font-size: 3em; color: #dee2e6;"></i>
                        <p class="text-muted mt-3">ì•„ì§ ë“±ë¡ëœ í—Œê¸ˆ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        <small class="text-muted">í—Œê¸ˆ ë‚´ì—­ì€ ê´€ë¦¬ìê°€ ë“±ë¡í•©ë‹ˆë‹¤.</small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ì•¡ì…˜ ë²„íŠ¼ë“¤ -->
    <div class="row mt-4 mb-4">
        <div class="col-12">
            <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                <a href="{% url 'budget:expense_request' %}" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> ìƒˆ ì§€ì¶œ ì‹ ì²­
                </a>
                <a href="{% url 'budget:expense_request_list' %}" class="btn btn-secondary">
                    <i class="bi bi-list-check"></i> ë‚´ ì‹ ì²­ ì „ì²´ ë³´ê¸°
                </a>
                <a href="{% url 'dashboard' %}" class="btn btn-outline-primary">
                    <i class="bi bi-house-door"></i> ëŒ€ì‹œë³´ë“œë¡œ
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}
